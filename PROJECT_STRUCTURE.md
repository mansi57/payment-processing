# Project Structure

This document describes the folder layout, key modules, and their responsibilities.

---

## Root Directory

```
payment-processing/
├── src/                        # TypeScript source code
├── dist/                       # Compiled JavaScript (generated by `npm run build`)
├── node_modules/               # npm dependencies
├── init-db/                    # SQL scripts mounted into PostgreSQL on first run
├── postman/                    # Postman collection & environment files
├── admin-dashboard/            # Static HTML served by Nginx for admin UI
├── grafana/                    # Grafana provisioning (dashboards & datasources)
├── uploads/                    # File upload storage
├── docker-compose.yml          # Multi-container orchestration
├── Dockerfile                  # Multi-stage Docker build (base → build → production)
├── tsconfig.json               # TypeScript compiler options
├── package.json                # Dependencies and npm scripts
├── prometheus.yml              # Prometheus scrape configuration
├── nginx.conf                  # Nginx reverse-proxy config for admin dashboard
├── ecosystem.config.js         # PM2 process manager config
├── .env                        # Environment variables (not committed)
├── README.md                   # Project overview & setup guide
├── ARCHITECTURE.md             # Flows, DB schema, design trade-offs, compliance
├── OBSERVABILITY.md            # Metrics, tracing, and logging strategy
├── QUEUE_ARCHITECTURE.md       # Deep-dive into Bull queue mechanism
├── API-SPECIFICATION.yml       # OpenAPI 3.0 spec
└── POSTMAN_COLLECTION.json     # Exported Postman collection
```

---

## Source Code (`src/`)

```
src/
├── index.ts                    # Application entry point
├── app.ts                      # Express app configuration & route mounting
│
├── config/                     # Centralised configuration
│   ├── index.ts                #   Environment variables, feature flags
│   └── queue.config.ts         #   Bull queue & Redis connection settings
│
├── middleware/                  # Express middleware
│   ├── auth.ts                 #   JWT authentication & role authorisation
│   ├── correlationId.ts        #   Distributed tracing (correlation/request IDs)
│   ├── errorHandler.ts         #   Global error handler & 404 handler
│   ├── idempotency.ts          #   Idempotency-key deduplication
│   └── validation.ts           #   Request body validation (Joi)
│
├── routes/                     # API route definitions
│   ├── auth.ts                 #   POST /api/auth/register, /login, /profile
│   ├── payments.ts             #   POST /api/payments/purchase, authorize, capture, void, refund
│   ├── subscriptions.ts        #   CRUD + pause/resume for /api/subscriptions
│   ├── webhooks.ts             #   CRUD for /api/webhooks/endpoints, deliveries
│   ├── database.ts             #   CRUD for /api/database/customers, orders, transactions
│   ├── queues.ts               #   GET /api/queues/health, stats, info; pause/resume/clear
│   ├── queues-simple.ts        #   Simplified queue routes (fallback)
│   └── tracing.ts              #   GET /api/tracing/stats, /active
│
├── services/                   # Business logic layer
│   ├── authorizeNetService.ts  #   Authorize.Net SDK integration (all transaction types)
│   ├── mockPaymentService.ts   #   Simulated payment gateway for testing
│   ├── webhookService.ts       #   Webhook event creation, endpoint matching, queue dispatch
│   ├── subscriptionService.ts  #   Subscription lifecycle & recurring billing
│   ├── databaseService.ts      #   PostgreSQL connection pool management
│   ├── migrationService.ts     #   Auto-run SQL migrations on startup
│   ├── storageService.ts       #   In-memory store for webhooks, idempotency, endpoints
│   ├── queueManager.ts         #   Bull queue creation, job scheduling, health checks
│   ├── eventEmitter.ts         #   Typed event producer → Bull queues
│   ├── metricsService.ts       #   Prometheus metric definitions & /metrics handler
│   └── processors/             #   Bull queue job processors
│       ├── webhookProcessor.ts #     HTTP POST delivery, retry, signature verification
│       └── databaseEventProcessor.ts # DB change-event handling & webhook triggers
│
├── repositories/               # Data access layer (repository pattern)
│   ├── customerRepository.ts   #   CRUD for customers table
│   ├── orderRepository.ts      #   CRUD for orders table
│   ├── transactionRepository.ts#   CRUD for transactions table
│   └── refundRepository.ts     #   CRUD for refunds table
│
├── workers/                    # Standalone worker processes
│   └── queue-worker.ts         #   Dedicated Bull consumer (runs in its own container)
│
├── types/                      # TypeScript interfaces & type definitions
│   ├── payment.types.ts        #   Payment request/response, gateway types
│   ├── database.types.ts       #   Entity interfaces (Customer, Order, Transaction, …)
│   ├── webhook.types.ts        #   WebhookEvent, WebhookEndpoint, EventData, …
│   ├── queue.types.ts          #   Queue event names, job payloads, priorities
│   ├── subscription.types.ts   #   Subscription, plan, billing cycle types
│   ├── tracing.types.ts        #   CorrelationContext, RequestTracing
│   ├── idempotency.types.ts    #   IdempotencyKey interface
│   ├── authorizenet.d.ts       #   Ambient type declarations for authorizenet SDK
│   └── express.d.ts            #   Express Request augmentation (correlationId, user)
│
├── utils/                      # Shared utility functions
│   ├── logger.ts               #   Winston logger setup
│   ├── tracingLogger.ts        #   Logger with automatic correlation-ID injection
│   ├── validation.ts           #   Input validation helpers
│   ├── advancedValidation.ts   #   Joi schemas for complex payloads
│   └── patchAuthorizeNet.ts    #   Monkey-patch to prevent SDK logger crash
│
└── migrations/                 # SQL migration files (run automatically)
    ├── 001_initial_schema.sql  #   Tables, indexes, triggers, views
    └── 002_add_users_and_auth.sql # Users table & JWT auth support
```

---

## Key Modules Explained

### `src/index.ts` — Entry Point

- Loads environment variables via `dotenv`
- Initialises the database connection & runs pending migrations
- Initialises the Bull queue system (connects to Redis, creates queues)
- Starts the Express HTTP server
- Registers graceful-shutdown handlers (`SIGTERM`, `SIGINT`)

### `src/app.ts` — Express Application

- Registers global middleware in order: Helmet → CORS → body-parser → Prometheus metrics middleware → correlation-ID middleware → Morgan HTTP logger
- Mounts all route groups under `/api/*`
- Exposes `/health` (public) and `/metrics` (Prometheus)
- Attaches the global error handler and 404 handler last

### `src/config/queue.config.ts` — Queue Configuration

Defines the five named queues, their Redis connection settings, default job options (retry attempts, exponential backoff, job retention), and priority levels (`CRITICAL`, `HIGH`, `NORMAL`, `BACKGROUND`).

### `src/services/authorizeNetService.ts` — Payment Gateway

Wraps the Authorize.Net Node.js SDK. Handles:
- `processPayment` (auth-capture in one step)
- `authorizePayment`, `capturePayment`, `voidPayment`, `refundPayment`
- Persists customers, orders, and transactions in PostgreSQL
- Emits webhook events (`payment.succeeded`, `payment.failed`, etc.) after each operation

### `src/services/webhookService.ts` — Webhook Orchestration

- `emitEvent(type, data)` — creates a `WebhookEvent` record, finds all matching endpoints, creates delivery records, and enqueues `DELIVER_WEBHOOK` jobs to the Bull `webhook-delivery` queue.
- No in-memory polling — delivery is fully asynchronous via the queue worker.

### `src/services/processors/webhookProcessor.ts` — Webhook Delivery

Runs inside the queue worker container. For each `deliver-webhook` job:
1. Sends an HTTP POST to the endpoint URL with the signed payload.
2. On 2xx — marks delivery as succeeded.
3. On 5xx/timeout — schedules a retry with exponential backoff (5 s → 25 s → 125 s).
4. On 4xx or max retries exceeded — marks delivery as permanently failed.

### `src/services/queueManager.ts` — Queue Manager

Singleton that creates and manages all five Bull queue instances. Provides:
- `addJob(queueName, jobType, data, options)` — enqueue a job
- `getQueueStats()` / `getQueueHealth()` — monitoring data for the `/api/queues/*` endpoints
- `pauseQueue()`, `resumeQueue()`, `cleanQueue()` — operational controls
- `shutdown()` — graceful close of all Redis connections

### `src/workers/queue-worker.ts` — Queue Worker Process

A standalone Node.js entry point (`dist/workers/queue-worker.js`) that:
1. Connects to PostgreSQL and Redis
2. Registers Bull processors for every queue and job type
3. Listens for jobs and processes them concurrently
4. Handles `SIGTERM` / `SIGINT` for graceful shutdown

### `src/middleware/correlationId.ts` — Distributed Tracing

Generates `corr_<uuid>` and `req_<uuid>` identifiers, attaches them to `req` and response headers (`X-Correlation-ID`, `X-Request-ID`), tracks active/completed requests for the `/api/tracing/stats` endpoint, and provides the data consumed by the Prometheus tracing gauges.

---

## Docker Services

| Service | Container Name | Image | Purpose |
|---|---|---|---|
| `postgres` | `payment_processing_db` | `postgres:15-alpine` | Primary database |
| `redis` | `payment_processing_redis` | `redis:7-alpine` | Queue backend |
| `payment-api` | `payment_processing_api` | Custom (Dockerfile) | Express API + queue producer |
| `queue-worker` | `payment_processing_queue_worker` | Custom (Dockerfile) | Bull queue consumer |
| `admin-dashboard` | `payment_processing_admin` | `nginx:alpine` | Admin UI |
| `prometheus` | `payment_processing_prometheus` | `prom/prometheus` | Metrics collection (optional `monitoring` profile) |
| `grafana` | `payment_processing_grafana` | `grafana/grafana` | Metrics dashboards (optional `monitoring` profile) |

---

## Design Patterns Used

| Pattern | Where | Benefit |
|---|---|---|
| **Repository** | `src/repositories/` | Isolates data access, simplifies testing |
| **Service Layer** | `src/services/` | Encapsulates business logic, reusable across routes |
| **Event-Driven / Producer-Consumer** | `eventEmitter` → Bull → `queue-worker` | Decoupled async processing, horizontal scaling |
| **Middleware Pipeline** | `src/middleware/` | Cross-cutting concerns (auth, tracing, validation) |
| **Strategy** | `authorizeNetService` vs `mockPaymentService` | Swap payment gateway at runtime via env var |

---

*Last updated: February 16, 2026*
